<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>OpenNI 1.5.7: NiRecordRaw.cpp - sample program</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="OpenNILogo.bmp"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenNI 1.5.7
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">OpenNI Overview</a></li><li class="navelem"><a class="el" href="smpls_n_guides.html">Samples and Guides</a></li><li class="navelem"><a class="el" href="smpls.html">Sample Programs for the OpenNI API</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">NiRecordRaw.cpp - sample program </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><pre class="fragment">&lt;b&gt;Source file:&lt;/b&gt; Click the following link to view the source code file:
    - NiRecordRaw.cpp

This section describes an OpenNI sample program for recording raw data, and then playing it back. Recording raw data may be useful for middleware developers who produce a custom type of data that isn't defined by OpenNI. In addition, recording raw data may also be useful for middleware developers who save additional debugging information in the ONI file. This additional data may be used in conjunction with the standard OpenNI data types such as depth output data stored in the file. In this case, each frame of debugging information will match a depth frame. 

In this sample, the raw data is artificial data that the application itself synthesizes.
</pre><h1><a class="anchor" id="recraw__sample_xml_path"></a>
Declaration of File Paths</h1>
<pre class="fragment">    In the following definitions, SAMPLE_XML_PATH is for the path to an OpenNI XML script input file for building a stored production graph. The &lt;i&gt;production graph&lt;/i&gt; is a network of &lt;i&gt;production nodes&lt;/i&gt; and is the principal OpenNI object model. See @ref prod_graph for more about production graph. RECORDING_FILE_NAME is the OpenNI output file to store the recording.
</pre> <div class="fragment"><div class="line"><span class="preprocessor">#define SAMPLE_XML_PATH &quot;../../../../Data/SamplesConfig.xml&quot;</span></div>
<div class="line"><span class="preprocessor">#define RECORDING_FILE_NAME &quot;recordingWithRaw.oni&quot;</span></div>
</div><!-- fragment --><h1><a class="anchor" id="bkrec_macros"></a>
Macro Declarations</h1>
<pre class="fragment">    At the top of the program are two macro utility declarations, both of which call OpenNI methods. They are described below. However, for the sake of conciseness, the rest of this documentation skips calls to these macros.

    The CHECK_RC_ERR() macro checks whether the most recent OpenNI operation for creating a production graph actually created a production graph or not. If no production graph was created (indicated by the &lt;code&gt;XN_STATUS_NO_NODE_PRESENT&lt;/code&gt; return code), the @ref xn::xnGetStatusString "xnGetStatusString()" method converts an error list to a  error string for printing. Either way, this macro then calls the &lt;code&gt;CHECK_RC()&lt;/code&gt; macro described above.
</pre> <div class="fragment"><div class="line"><span class="preprocessor">#define CHECK_RC_ERR(rc, what, error) \</span></div>
<div class="line"><span class="preprocessor">  ...           </span></div>
</div><!-- fragment --><h1><a class="anchor" id="recraw_mainprg_dcl_blk"></a>
Main Program - Declaration Block</h1>
<pre class="fragment">    The declaration block at the top of the main program declares an OpenNI status flag for collecting return values from method calls.
</pre> <div class="fragment"><div class="line"><a class="code" href="_xn_status_8h.html#a23967099202ddb640cd2044b3808253c">XnStatus</a> nRetVal = <a class="code" href="_xn_status_8h.html#a92729089d8e28e740a3f8b5169c8f695">XN_STATUS_OK</a>;</div>
</div><!-- fragment --><h1><a class="anchor" id="recraw_mainprg"></a>
Main Program</h1>
<h2><a class="anchor" id="recraw_record"></a>
Recording Data</h2>
<pre class="fragment">        In the following, the @ref xn::xnLogInitFromXmlFile() function initializes the log from an XML file. 
</pre> <div class="fragment"><div class="line">nRetVal = <a class="code" href="_xn_log_8h.html#a98c98054c03755c961d383e12b36b7dc">xnLogInitFromXmlFile</a>(SAMPLE_XML_PATH);</div>
</div><!-- fragment --><p>The following initalizes the <a class="el" href="classxn_1_1_context.html">xn::Context</a> object. This is a workspace where the application builds an OpenNI production graph. The <em>production graph</em> is a network of <em>production nodes</em> and is the principal OpenNI object structure. </p>
<div class="fragment"><div class="line">Context context;</div>
<div class="line">nRetVal = context.Init();</div>
</div><!-- fragment --><p>The following statement initializes a Recorder object. This object records to a specified destination medium the frames of data from each node that was added to the Recorder node. </p>
<div class="fragment"><div class="line">nRetVal = recorder.Create(context);</div>
</div><!-- fragment --><p>The following call specifies to where the recorder must send its recording.</p>
<dl class="section note"><dt>Note</dt><dd>Disk files are the only medium that this installation currently supports.</dd></dl>
<div class="fragment"><div class="line">nRetVal = recorder.SetDestination(<a class="code" href="group__recorder.html#gga3a9ee4c35a7384ba06a4d22f976f8e8aab2fd201e9160a675b83ca2a3e4d36a0c">XN_RECORD_MEDIUM_FILE</a>, RECORDING_FILE_NAME);</div>
</div><!-- fragment --><p>The following code creates a mock node. This is to simulate an actual node when recording or playing data from a recording. A mock node does not contain any logic for generating data. Instead, it allows an outside component &ndash; such as an application or a real node &ndash; to feed it configuration changes and data. </p>
<div class="fragment"><div class="line">MockRawGenerator rawGenerator;</div>
<div class="line">nRetVal = rawGenerator.Create(context, <span class="stringliteral">&quot;MockRaw&quot;</span>);</div>
</div><!-- fragment --><p>The following statements set properties of the <a class="el" href="classxn_1_1_mock_raw_generator.html">rawGenerator</a> node. It creates a string property named Type and assigns it the value "ReverseT", creates an integer property named X and assigns it the value 5. This depends on the middleware developer that is using this feature. It could be any parameter that the middleware code might later need for debugging purposes or for custom data types. </p>
<div class="fragment"><div class="line">nRetVal = rawGenerator.SetStringProperty(<span class="stringliteral">&quot;Type&quot;</span>, <span class="stringliteral">&quot;ReverseT&quot;</span>);</div>
<div class="line">nRetVal = rawGenerator.SetIntProperty(<span class="stringliteral">&quot;X&quot;</span>, 5);</div>
</div><!-- fragment --><p>The following statement adds the node to the recording setup, and starts recording it. </p>
<div class="fragment"><div class="line">nRetVal = recorder.AddNodeToRecording(rawGenerator);</div>
</div><!-- fragment --><p>The following example shows that properties can also be set after the node has been added to the recording. </p>
<div class="fragment"><div class="line">nRetVal = rawGenerator.SetIntProperty(<span class="stringliteral">&quot;Y&quot;</span>, 8);</div>
</div><!-- fragment --><p>The following main application loop sets artificial data in the rawGenerator node. The parameters to the SetData() call, in order, are nFrameID and nTimestamp, both generated from the loop counter - abd then the nDataSize and a pointer to the data buffer. </p>
<div class="fragment"><div class="line">XnChar buff[20];</div>
<div class="line"><span class="keywordflow">for</span> (XnUInt32 i = 1; i &lt;= 10; i++)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (XnUInt32 j = 0; j &lt; 20; j++)</div>
<div class="line">    {</div>
<div class="line">        buff[j] = i;</div>
<div class="line">    }</div>
<div class="line">    nRetVal = rawGenerator.SetData(1000 * i, i, <span class="keyword">sizeof</span>(buff), buff);nRetVal = recorder.Record();</div>
</div><!-- fragment --><p>In the above, the <a class="el" href="classxn_1_1_recorder.html#a94a2c702fd2c5e2466b813bb585e6fc9">Record()</a> method records one frame of data from each node added to the recorder. To record continually, the recorder node must be called repeatedly for each frame.</p>
<p>On completion of the loop, the following code removes the node from the Recorder object and so stops recording the node output. The code then releases the <a class="el" href="classxn_1_1_recorder.html">Recorder</a> and <a class="el" href="classxn_1_1_mock_raw_generator.html">MockRawGenerator</a> nodes. Releasing the nodes unreferences them, decreasing their reference counts by 1. If a node's reference count reaches zero, it will be destroyed. </p>
<div class="fragment"><div class="line">nRetVal = recorder.RemoveNodeFromRecording(rawGenerator);</div>
<div class="line">   ...</div>
<div class="line">recorder.Release();</div>
<div class="line">   ...</div>
<div class="line">rawGenerator.Release();</div>
</div><!-- fragment --><p>This completes the recording example. All recorded data has been recorded in the file whose name is given in RECORDING_FILE_NAME.</p>
<h2><a class="anchor" id="recraw_play"></a>
Plays Back Recorded Data</h2>
<pre class="fragment">        The application now builds a production graph to play back the data recorded above 

        The following statement gets a handle to an existing production node instance using that instance name. It is already known that there exists a node with the instance name "MockRaw".  
</pre> <div class="fragment"><div class="line">nRetVal = context.GetProductionNodeByName(<span class="stringliteral">&quot;MockRaw&quot;</span>, rawGenerator);</div>
</div><!-- fragment --><p>The following code replays a recorded file of a session of OpenNI data generation exactly as it was recorded. the <a class="el" href="classxn_1_1_player.html">xn::Player</a> node is for playing a saved recording of an OpenNI data generation session. The RECORDING_FILE_NAME string contains the file name, as above. </p>
<div class="fragment"><div class="line">Player player;</div>
<div class="line">nRetVal = context.OpenFileRecording(RECORDING_FILE_NAME, player);</div>
</div><!-- fragment --><p>The following statement specifies whether the player will automatically rewind to the beginning of the recording after reaching the end of the recording. </p>
<div class="fragment"><div class="line">nRetVal = player.SetRepeat(<a class="code" href="_xn_platform_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div>
</div><!-- fragment --><div class="fragment"><div class="line">nRetVal = context.GetProductionNodeByName(<span class="stringliteral">&quot;MockRaw&quot;</span>, rawGenerator);</div>
</div><!-- fragment --><p>The following program loop waits for available data from any generator node and prints it out. The <a class="el" href="classxn_1_1_context.html#a17fab043d7b6d60728511527a1d5c090">WaitAnyUpdateAll()</a> method updates all generator nodes in the context that have new data available, first waiting for any of the nodes to have new data available. The application can then get the data (for example, using a metadata <code>GetData()</code> method). This method has a timeout. </p>
<div class="fragment"><div class="line"><span class="keywordflow">while</span> ((nRetVal = context.WaitAnyUpdateAll()) != XN_STATUS_EOF)</div>
<div class="line">{</div>
<div class="line">    CHECK_RC(nRetVal, <span class="stringliteral">&quot;Read data from file&quot;</span>);</div>
<div class="line">    pData = (<span class="keyword">const</span> XnChar*)rawGenerator.GetData();</div>
<div class="line">    nSize = rawGenerator.GetDataSize();</div>
<div class="line">    <span class="keywordflow">for</span> (XnUInt32 i = 0; i &lt; nSize; i++)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;%d &quot;</span>, pData[i]);</div>
<div class="line">    }</div>
<div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>On completion of the loop, the following code removes the node from the Player object and and so stops playing the recording. All other objects are also released. See ealier for a more detailed description of Release(). </p>
<div class="fragment"><div class="line">player.Release();</div>
<div class="line">rawGenerator.Release();</div>
<div class="line">recorder.Release();</div>
<div class="line">context.Release();</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Nov 12 2013 13:40:21 for OpenNI 1.5.7 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
