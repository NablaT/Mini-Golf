<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>OpenNI 1.5.7: HandTracker.java - sample program (java)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="OpenNILogo.bmp"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenNI 1.5.7
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">OpenNI Overview</a></li><li class="navelem"><a class="el" href="smpls_n_guides.html">Samples and Guides</a></li><li class="navelem"><a class="el" href="smpls.html">Sample Programs for the OpenNI API</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">HandTracker.java - sample program (java) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><pre class="fragment">&lt;b&gt;Source file:&lt;/b&gt; Click the following link to view the source code file:
    -  HandTracker.java\\HandTracker.java  

This section describes an OpenNI sample program for tracking a hand. This sample is encapsulated in the org.openni.Samples.HandTracker.jar (java archive).

The documentation describes the sample program's code from the top of the program file(s) to bottom.

Every OpenNI feature is described the first time it appears in this sample program. Further appearances of the same feature are not described again.    
</pre><h1><a class="anchor" id="hnd_trk_class_title"></a>
HandTracker Class Title</h1>
<pre class="fragment">    The whole program is defined inside the &lt;code&gt;HandTracker&lt;/code&gt; Class. 
</pre><h1><a class="anchor" id="htj_evhndlr_gestrec"></a>
Handler for 'Gesture Recognized' Event</h1>
<pre class="fragment">    The @ref xn::GestureGenerator::GestureRecognized "'Gesture Recognized'" event signals that the @ref xn::GestureGenerator "GestureGenerator" node has recognized the named gesture in the scene. 

    The following code block defines the event handler for the 'Gesture Recognized' event.
</pre> <div class="fragment"><div class="line"><span class="keyword">class </span>MyGestureRecognized <span class="keyword">implements</span> IObserver&lt;GestureRecognizedEventArgs&gt;</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>The following is the main code in the body of the event handler. </p>
<pre class="fragment">The event handler calls the @ref xn::HandsGenerator::StartTracking()  "StartTracking()" method of the @ref xn::HandsGenerator "HandsGenerator" node. This method causes the HandsGenerator node to start tracking at the specific position where the application expects a hand, which the application supplies as a parameter of the org.openni.Point3D type. The parameter is @ref xn::XnGestureRecognized "getEndPosition()", which is the position of the hand at the end of the gesture.
</pre> <div class="fragment"><div class="line">handsGen.StartTracking(args.getEndPosition());</div>
<div class="line">gestureGen.removeGesture(<span class="stringliteral">&quot;Click&quot;</span>);</div>
</div><!-- fragment --><p>The getEndPosition() method gets the <code>pEndPosition</code> parameter from, the event handler, which is the position of the hand at the end of the gesture.</p>
<p>Now that the HandsGenerator is tracking a hand, the GestureGenerator does not have to look for the gesture anymore. So it does this by calling the <a class="el" href="classxn_1_1_gesture_generator.html#ac0874c99cf5da72e9eea84301719010e">RemoveGesture()</a> method to disable the GestureGenerator from looking for the named gesture in the FOV. </p>
<div class="fragment"><div class="line">gestureGen.removeGesture(<span class="stringliteral">&quot;Click&quot;</span>);</div>
</div><!-- fragment --><h1><a class="anchor" id="htj_evhndlr_handcrt"></a>
Handler for 'Hand Create' Event</h1>
<pre class="fragment">    Some implementations may want to use the @ref xn::HandsGenerator::HandCreate "'Hand Create'" event to signal that the @ref xn::HandsGenerator "HandsGenerator" node has recognized and started tracking a new hand in response to the application calling the xn::() method. This event returns the ID of the new hand, the time of its recognition, and its position on recognition in the current frame.  

    The following code block defines the event handler for the 'Hand Create' event.
</pre> <div class="fragment"><div class="line"><span class="keyword">class </span>MyHandCreateEvent <span class="keyword">implements</span> IObserver&lt;ActiveHandEventArgs&gt;</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>The following is the main code in the body of the event handler. </p>
<pre class="fragment">The event handler calls a new list of @ref XnPoint3D "org.openni.Point3D" type structs. The &lt;code&gt;getPosition()&lt;/code&gt; method returns the position at which the hand was created.
</pre> <div class="fragment"><div class="line">ArrayList&lt;Point3D&gt; newList = <span class="keyword">new</span> ArrayList&lt;Point3D&gt;();</div>
<div class="line">newList.add(args.getPosition());</div>
</div><!-- fragment --><p>Now that the HandsGenerator is tracking the hand, it adds it to a history list created by this application. The history list is described later in <a class="el" href="smpl_handtracker_java.html#rec_raw_mainprg_dcl_blk_hist">declaration block</a>. </p>
<div class="fragment"><div class="line">history.put(<span class="keyword">new</span> Integer(args.getId()), newList);</div>
</div><!-- fragment --><h1><a class="anchor" id="htj_evhndlr_handupd"></a>
Handler for 'Hand Update' Event</h1>
<pre class="fragment">    The @ref xn::HandsGenerator::HandUpdate "'Hand Update'" event signals that the @ref xn::HandsGenerator "HandsGenerator" node signals that a currently tracked hand was recognized at a specific position in the new frame. OpenNI continues to send this event at each further frame that the hand is still present. This event returns the ID of the hand, which is the same ID returned by the HandCreate event, the hand's new position, and the time of the update.

    The following code block defines the event handler for the 'Hand Update' event.
</pre> <div class="fragment"><div class="line"><span class="keyword">class </span>MyHandUpdateEvent <span class="keyword">implements</span> IObserver&lt;ActiveHandEventArgs&gt;</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>The following is the main code in the body of the event handler. The assignment in the first statement adds the new position of the hand to its own history buffer. The 'history' is a hash from an integer (the hand's unique, persistent ID) and a list of its last locations.</p>
<p>When adding a new location of the hand, we want to add them to the correct list. </p>
<div class="fragment"><div class="line">ArrayList&lt;Point3D&gt; historyList = history.get(args.getId());</div>
<div class="line"></div>
<div class="line">historyList.add(args.getPosition());</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">while</span> (historyList.size() &gt; historySize)</div>
<div class="line">{</div>
<div class="line">    historyList.remove(0);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The above while loop provides a maximum history size, giving a 'moving tail' effect. This means that if there are too many points in the buffer, the oldest one is removed.</p>
<h1><a class="anchor" id="htj_evhndlr_handdestr"></a>
Handler for 'Hand Destroy' Event</h1>
<pre class="fragment">    The @ref xn::HandsGenerator::HandUpdate "'Hand Destroy'" event signals that an existing hand has disappeared from the frame for any reason. This event returns the user ID &amp;ndash; still the same user ID as before &amp;ndash; and the time that it disappeared.

    The following code block defines the event handler for the 'Hand Destroy' event.
</pre> <div class="fragment"><div class="line">MyHandDestroyEvent implements IObserver&lt;InactiveHandEventArgs&gt;</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>The following code is the main code in the body of the event handler.</p>
<p>Now that the hand has been destroyed, in this example, the application wants to remove the user's ID from the history list. So the program gets the user's ID from the handler argument <code>args.getId</code>.</p>
<p>The code block below first removes the specific user's history buffer by calling <code>history.remove()</code>, and then we check if the general history is left empty, which means all hands were removed. The code then calls <code>history.isEmpty()</code> to check if the <code>history</code> listof hands has now become empty as a result of this hand having been destroyed. If it is empty, the program will then want to again start looking for the "Click" gesture. Thus, it then calls the <a class="el" href="classxn_1_1_gesture_generator.html#a0cdf45854e49ff2d4f3c5f24b75428d8">AddGesture()</a> method. </p>
<div class="fragment"><div class="line">history.remove(args.getId());</div>
<div class="line"><span class="keywordflow">if</span> (history.isEmpty())</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">        gestureGen.addGesture(<span class="stringliteral">&quot;Click&quot;</span>);</div>
<div class="line">    } <span class="keywordflow">catch</span> (StatusException e)</div>
<div class="line">    {</div>
<div class="line">        e.printStackTrace();</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="htj_mainprg_dcl_blk"></a>
Main Program Declaration Block: OpenNI Nodes</h1>
<pre class="fragment">    The declaration block immediately above the main program (try) declares the OpenNI objects required for building the OpenNI production graph. The production graph is the main object model in OpenNI. 
</pre> <div class="fragment"><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keywordtype">long</span> serialVersionUID = 1L;</div>
<div class="line"><span class="keyword">private</span> OutArg&lt;ScriptNode&gt; scriptNode;</div>
<div class="line"><span class="keyword">private</span> Context context;</div>
<div class="line"><span class="keyword">private</span> DepthGenerator depthGen;</div>
<div class="line"><span class="keyword">private</span> GestureGenerator gestureGen;</div>
<div class="line"><span class="keyword">private</span> HandsGenerator handsGen;</div>
</div><!-- fragment --><p>Each of these concepts is described separately in the following paragraphs.</p>
<p>The <a class="el" href="prod_graph.html">production graph</a> is a network of software objects - called production nodes - that can identify blobs as hands or human users. In this sample program the production graph identifies blobs as human users, and tracks them as they move.</p>
<p>the <a class="el" href="classxn_1_1_script_node.html">ScriptNode</a> object loads an XML script from a file or string, and then runs the XML script to build a production graph.</p>
<p>a <a class="el" href="classxn_1_1_context.html">Context</a> object is a workspace in which the application builds an OpenNI production graph.</p>
<p>a <a class="el" href="classxn_1_1_depth_generator.html">DepthGenerator</a> node generates a depth map. Each map pixel value represents a distance from the sensor.</p>
<p>A <a class="el" href="classxn_1_1_gesture_generator.html">GestureGenerator</a> node recognizes certain hand gestures and raise corresponding events accordingly. A gesture is a specific hand movement. The GestureGenerator node scans the FOV to detect gestures and generates the gesture data.</p>
<p>A <a class="el" href="classxn_1_1_hands_generator.html">HandsGenerator</a> node generates tracking data about a single hand or multiple hands with persistent IDs.</p>
<h1><a class="anchor" id="rec_raw_mainprg_dcl_blk_hist"></a>
Main Program Declaration Block: Application Histogram</h1>
<pre class="fragment">    The following declaration block defines data structures for the application histogram. These are not OpenNI-specific declarations.
</pre> <div class="fragment"><div class="line"><span class="keyword">private</span> HashMap&lt;Integer, ArrayList&lt;Point3D&gt;&gt; history;</div>
<div class="line"><span class="keyword">private</span> byte[] imgbytes;</div>
<div class="line"><span class="keyword">private</span> <span class="keywordtype">float</span> histogram[];</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span> BufferedImage bimg;</div>
<div class="line"><span class="keywordtype">int</span> width, height;</div>
</div><!-- fragment --><p> <code>history</code> is a history list of <a class="el" href="_xn_types_8h.html#a200e09e2dc6145ac3c44151799c25014">org.openni.Point3D </a> objects, which are the 3D (x,y,z) co-ordinates of each depth pixel in the depth map generated by a DepthGenerator node.</p>
<p><code>histogram</code> is an array of floats to build a histogram of distribution of depth values. It will be used to represent different depth values with different colors..</p>
<p>The following declaration for <code>SAMPLE_XML_FILE</code> is the path to an OpenNI XML script file for inputting and building a stored production graph. private final String SAMPLE_XML_FILE = "../../../../Data/SamplesConfig.xml";</p>
<h1><a class="anchor" id="setup_pg"></a>
HandTracker() method: Setting up the Production Graph</h1>
<pre class="fragment">    The public HandTracker() routine sets up the Production Graph.

    The following code initialization initializes the production graph from an OpenNI XML script file The call to @ref xn::Context::InitFromXmlFile "Context.createFromXmlFile()" combines the effects of two other initialization methods &amp;ndash; @ref xn::Context::Init() and then @ref xn::Context::RunXmlScriptFromFile() &amp;ndash; to initialize the context object and then create a production graph.@code 
        scriptNode = new OutArg&lt;ScriptNode&gt;();
        context = Context.createFromXmlFile(SAMPLE_XML_FILE, scriptNode);
    @endcode    

    The following statements create and set up a GestureGenerator node. The addGesture() method activates the GestureGenerator node to start looking for the named gesture ("Click") in the FOV by adding the gesture's name to the node's list of gestures it actively scans for in the FOV.
</pre> <div class="fragment"><div class="line">gestureGen = GestureGenerator.create(context);</div>
<div class="line">gestureGen.addGesture(<span class="stringliteral">&quot;Click&quot;</span>); {Not exactly the same as in the API}</div>
</div><!-- fragment --><p>The following statement sets up an event handler for the 'Gesture Recognized' event. The handler is the MyGestureRecognized() function declared elsewhere in the program sample. </p>
<div class="fragment"><div class="line">gestureGen.getGestureRecognizedEvent().addObserver(<span class="keyword">new</span> MyGestureRecognized() ); </div>
</div><!-- fragment --><p>The following code block sets up event handlers for a number of hand recognition events. For details about these events, see <a href="#xncpp_wrpr_handgen_events">Hand Event Sequence Diagram</a>, and <a href="#xncpp_wrpr_handcreate_ev">'Hand Create'</a>, <a href="#xncpp_wrpr_handupdate_ev">'Hand Update'</a>, and <a href="#xncpp_wrpr_handdestroy_ev">'Hand Destroy'</a>. </p>
<div class="fragment"><div class="line">handsGen = HandsGenerator.create(context);</div>
<div class="line">handsGen.getHandCreateEvent().addObserver(<span class="keyword">new</span> MyHandCreateEvent());</div>
<div class="line">handsGen.getHandUpdateEvent().addObserver(<span class="keyword">new</span> MyHandUpdateEvent());</div>
<div class="line">handsGen.getHandDestroyEvent().addObserver(<span class="keyword">new</span> MyHandDestroyEvent());</div>
</div><!-- fragment --><p>The following statement creates a <a class="el" href="classxn_1_1_depth_generator.html">DepthGenerator</a>. </p>
<div class="fragment"><div class="line">depthGen = DepthGenerator.create(context);</div>
</div><!-- fragment --><p>In the following statement, the latest data generated is copied to an easy-to-access <a class="el" href="glossary.html#glos_frame_object">&lt;i&gt;frame object&lt;/i&gt;</a>. In OpenNI terminology: the node has data that is designated as 'metadata to be placed in the node's metadata object'. The node's getMetaData() method gets this data and copies it to a metadata object, <code>depthMD</code>. The data includes all configuration information associated with the data itself. This metadata object is then termed the <a class="el" href="glossary.html#glos_frame_object">&lt;i&gt;frame object&lt;/i&gt;</a>. <br/>
 For more explanation on this, see <a class="el" href="conc_meta_data.html">Frame Objects and Metadata Objects</a>, <a class="el" href="glossary.html#glos_frame_object">Frame Objects</a>, and <a class="el" href="glossary.html#frame_data">Frame Data (Data Frame)</a>. </p>
<div class="fragment"><div class="line">DepthMetaData depthMD = depthGen.getMetaData();</div>
</div><!-- fragment --><p>The following statement ensures all created <a class="el" href="glossary.html#dict_gen_node">generator nodes</a> are generating data. </p>
<div class="fragment"><div class="line">context.startGeneratingAll();</div>
</div><!-- fragment --><p>The following sets up the histogram (see <a class="el" href="smpl_handtracker_java.html#rec_raw_mainprg_dcl_blk_hist">Main Program Declaration Block: Application Histogram</a>). See <code>getFullXRes</code> and <code>getFullYRes</code> get the number of rows and columns in the full frame (that is, the entire field-of-view), ignoring cropping. This enables the program set up the right size buffer. </p>
<div class="fragment"><div class="line">history = <span class="keyword">new</span> HashMap&lt;Integer, ArrayList&lt;Point3D&gt;&gt;(); </div>
<div class="line"></div>
<div class="line">histogram = <span class="keyword">new</span> <span class="keywordtype">float</span>[10000];</div>
<div class="line">width = depthMD.getFullXRes();</div>
<div class="line">height = depthMD.getFullYRes();</div>
<div class="line"></div>
<div class="line">imgbytes = <span class="keyword">new</span> byte[width*height];</div>
<div class="line"></div>
<div class="line">DataBufferByte dataBuffer = <span class="keyword">new</span> DataBufferByte(imgbytes, width*height);</div>
<div class="line">Raster raster = Raster.createPackedRaster(dataBuffer, width, height, 8, null);</div>
<div class="line">bimg = <span class="keyword">new</span> BufferedImage(width, height, BufferedImage.TYPE_BYTE_GRAY);</div>
<div class="line">bimg.setData(raster);</div>
</div><!-- fragment --><h1><a class="anchor" id="htj_calcHist"></a>
CalcHist() - Using the Depth Values to Build an Accumulative Histogram</h1>
<pre class="fragment">    There are no OpenNI-specific declarations in this routine.
</pre><h1><a class="anchor" id="htj_update_depth_fn"></a>
updateDepth() method: Updating the Depth Map</h1>
<pre class="fragment">    The following statement sets up the frame object. It is described in the &lt;a href="#getMetaData"&gt;HandTracker() method above&lt;/a&gt;. For more explanation on this, see @ref conc_meta_data, @ref glos_frame_object, and @ref frame_data.
</pre> <div class="fragment"><div class="line">DepthMetaData depthMD = depthGen.getMetaData();</div>
</div><!-- fragment --><p>The following method call waits for any node to have generated new data. This method then 'updates' each and every node in the entire production graph. For an overview to reading data and the <b>WaitXUpdateAll</b> methods, see <em><a class="el" href="conc_updating_data.html#conc_updating_data__summary_of_wait_fns">'Wait and Update' Methods</a></em>.</p>
<p>The <a class="el" href="classxn_1_1_context.html#a17fab043d7b6d60728511527a1d5c090">waitAnyUpdateAll()</a> method in the following statement waits for any node to have generated a new data frame. The method then makes the data frames of all nodes in the entire production graph available for getting. The application can then get the data (for example, using a metadata GetData() method). This method has a timeout. </p>
<div class="fragment"><div class="line">context.waitAnyUpdateAll();</div>
</div><!-- fragment --><p>The following code block creates a convenient buffer for the depth map and then calls the calcHist() method to calculate the histogram. There are no OpenNI-specific operations in this code block. </p>
<div class="fragment"><div class="line">ShortBuffer depth = depthMD.getData().createShortBuffer();</div>
<div class="line">calcHist(depth);</div>
<div class="line">depth.rewind();     </div>
</div><!-- fragment --><p>This code block copies the depth into a local buffer, so that it can be drawn on the screen. </p>
<div class="fragment"><div class="line"><span class="keywordflow">while</span>(depth.remaining() &gt; 0)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> pos = depth.position();</div>
<div class="line">    <span class="keywordtype">short</span> pixel = depth.get();</div>
<div class="line">    imgbytes[pos] = (byte)histogram[pixel];</div>
<div class="line">}       </div>
</div><!-- fragment --><h1><a class="anchor" id="htj_getPreferredSize"></a>
getPreferredSize() method</h1>
<pre class="fragment">    There are no OpenNI-specific operations in this routine.        
</pre><h1><a class="anchor" id="htj_paint"></a>
paint() method</h1>
<pre class="fragment">    This function draws the current location of each known hand, with a tail consisting of its previous points. It uses the history list populated in the HandGenerator callbacks.</pre> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Nov 12 2013 13:40:21 for OpenNI 1.5.7 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
