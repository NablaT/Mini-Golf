<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>OpenNI 1.5.7: SimpleViewer.net - sample program  (C#/.NET)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="OpenNILogo.bmp"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenNI 1.5.7
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">OpenNI Overview</a></li><li class="navelem"><a class="el" href="smpls_n_guides.html">Samples and Guides</a></li><li class="navelem"><a class="el" href="smpls.html">Sample Programs for the OpenNI API</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">SimpleViewer.net - sample program (C#/.NET) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><pre class="fragment">&lt;b&gt;Source file:&lt;/b&gt; Click the following link to view the source code file:
    - SimpleViewer.net/MainWindow.cs

This section describes the SimpleViewer.net sample program in the C# language for .NET. 

This sample program demonstrates using a @ref xn::DepthGenerator "DepthGenerator" node to build an accumulative histogram from depth values.

The documentation describes the sample program's code from the top of the program file(s) to bottom.

Every OpenNI feature is described the first time it appears in this sample program. Further appearances of the same feature are not decribed again. 
</pre><h1><a class="anchor" id="svcs_glb_dcl_blk_ref"></a>
"Declaration Block" section</h1>
<pre class="fragment">    The reader may find it convenient to study the global declaration block before continuing to study the code statements. The global declaration block is documented later in this section, corresponding to its position in the program file &amp;ndash; see @ref svcs_glb_dcl_blk .
</pre><h1><a class="anchor" id="svcs_func_main"></a>
MainWindow()</h1>
<h2><a class="anchor" id="svcs_scrpt_sets_up_pg"></a>
Uses a Script to Set up a Context and Production Graph</h2>
<pre class="fragment">        The @ref xn::Context::InitFromXmlFile() "CreateFromXmlFile()" method is a shorthand combination of two other initialization methods &amp;mdash; &lt;code&gt;Create()&lt;/code&gt; and then @ref xn::Context::RunXmlScriptFromFile() "RunXmlScriptFromFile()" &amp;mdash; which initializes the @ref xn::Context  "Context" object and then creates a production graph from an XML file. The method returns a scriptNode which is the owner of all the nodes created by the script. This node should be kept until those nodes aren't needed anymore.

        The XML script file describes all the nodes you want to create. For each node description in the XML file, this method creates a node in the production graph.      
</pre> <div class="fragment"><div class="line">InitializeComponent();</div>
<div class="line">this.context = Context.CreateFromXmlFile(SAMPLE_XML_FILE, out scriptNode);</div>
</div><!-- fragment --><p>Assuming that the above call to CreateFromXmlFile succeeded, a production graph is then created.</p>
<h2><a class="anchor" id="svcs_get_dg_node_from_pg"></a>
Get a DepthGenerator Node from the Production Graph</h2>
<pre class="fragment">        The @ref xn::Context::FindExistingNode() "FindExistingNode()" method in the following code block tries to get a reference to any one of the production nodes. This call specifies &lt;code&gt;NodeType.Depth&lt;/code&gt; to get a reference to a @ref xn::DepthGenerator "DepthGenerator" node. A DepthGenerator node generates a depth map as an array of pixels, where each pixel is a depth value representing a distance from the sensor in millimeters. A reference to the node is returned in the depth parameter.   
</pre> <div class="fragment"><div class="line">this.depth = context.FindExistingNode(NodeType.Depth) as DepthGenerator;</div>
</div><!-- fragment --><p>The code block that follows the FindExistingNode() call just checks that OpenNI found a DepthGenerator node in the production graph. </p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (this.depth == null)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">&quot;Viewer must have a depth node!&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="svcs_set_ujp_hist_array"></a>
Using DepthGenerator characterstics to set up Histogram and Image Buffer</h2>
<pre class="fragment">        The following sets up the array for the histogram array that is a key part of this sample program. (This is not OpenNI specific.) xn::DepthGenerator::GetDeviceMaxDepth() "GetDeviceMaxDepth" gets the maximum depth (depth resolution) that the DepthGenerator node can produce.
        This is the same as the resolution of the depth axis 
        (i.e., @ref xn::DepthGenerator::GetDeviceMaxDepth() "DeviceMaxDepth()" + 1). 
</pre> <div class="fragment"><div class="line">this.histogram = <span class="keyword">new</span> <span class="keywordtype">int</span>[this.depth.DeviceMaxDepth];</div>
</div><!-- fragment --><p>The following statement gets the Map Output mode of the <a class="el" href="classxn_1_1_depth_generator.html">DepthGenerator</a> node. The <code>xnMapOutputMode</code> value returned by <a class="el" href="classxn_1_1_map_generator.html#a1fd1a64c376d7a47b2951bd996939644">xn::MapGenerator::GetMapOutputMode</a> is the combination of the node's scene resolution and frame rate. </p>
<div class="fragment"><div class="line">MapOutputMode mapMode = this.depth.MapOutputMode;</div>
</div><!-- fragment --><p>The following statement accesses the Map Output mode to get the DepthGenerator's map dimensions. <a class="el" href="classxn_1_1_map.html#addae31672b376dc4a79d8856b831ab1b">XRes</a> and <a class="el" href="classxn_1_1_map.html#a12df2e51951f42f4265e27e14d8d412b">YRes</a> get the frame's X and Y resolutions of the most recently generated data. X and Y are the number of columns and rows, respectively, in the frame after any required cropping has been applied. See <a class="el" href="conc_map_wrapper_classes.html">Map Wrapper Classes</a> for more information. A default format, 'Rgb24', is used for pixel color format. </p>
<div class="fragment"><div class="line">this.bitmap = <span class="keyword">new</span> Bitmap((<span class="keywordtype">int</span>)mapMode.XRes, (<span class="keywordtype">int</span>)mapMode.YRes,</div>
<div class="line">                System.Drawing.Imaging.PixelFormat.Format24bppRgb);</div>
</div><!-- fragment --><p>The following statements start the main reader thread. These statements are not OpenNI specific. </p>
<div class="fragment"><div class="line">this.shouldRun = <span class="keyword">true</span>;</div>
<div class="line">this.readerThread = <span class="keyword">new</span> Thread(ReaderThread);</div>
<div class="line">this.readerThread.Start();</div>
</div><!-- fragment --><h2><a class="anchor" id="svcs_onpaint"></a>
OnPaint() method</h2>
<pre class="fragment">        This method is not OpenNI specific.
</pre><h2><a class="anchor" id="svcs_onpaintbkgd"></a>
OnPaintBackground() method</h2>
<pre class="fragment">        This method is not OpenNI specific.
</pre><h2><a class="anchor" id="svcs_onclosing"></a>
OnClosing() method</h2>
<pre class="fragment">        This method is not OpenNI specific.         
</pre><h2><a class="anchor" id="svcs_onkeypress"></a>
OnKeyPress() method</h2>
<pre class="fragment">        This method is not OpenNI specific.         
</pre><h2><a class="anchor" id="svcs_calchist"></a>
CalcHist() method</h2>
<pre class="fragment">        This method uses the depth values to build an accumulative histogram of frequency of occurrence of each depth value. The &lt;code&gt;pDepth&lt;/code&gt; pointer accesses each value in the depth buffer and then uses it as an index into the &lt;code&gt;histogram&lt;/code&gt; array.
</pre> <div class="fragment"><div class="line"><span class="keyword">private</span> unsafe <span class="keywordtype">void</span> CalcHist(DepthMetaData depthMD)</div>
<div class="line">{</div>
<div class="line">    ... </div>
<div class="line">    ... </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; depthMD.YRes; ++y)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; depthMD.XRes; ++x, ++pDepth)</div>
<div class="line">        {</div>
<div class="line">            ushort depthVal = *pDepth;</div>
<div class="line">            <span class="keywordflow">if</span> (depthVal != 0)</div>
<div class="line">            {</div>
<div class="line">                this.histogram[depthVal]++;</div>
<div class="line">                points++;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }   </div>
<div class="line">    ... </div>
<div class="line">    ...                     </div>
</div><!-- fragment --><h1><a class="anchor" id="svcs_reader_thread"></a>
ReaderThread() method</h1>
<pre class="fragment">    The @ref xn::DepthMetaData "DepthMetaData" object provides a @ref glos_frame_object "frame object" for the @ref xn::DepthGenerator "DepthGenerator" node. A @ref dict_gen_node "generator node's" frame object contains the generated data frame) and all its associated properties. This frame object, comprising the data frame and its properties, is accessible through the node's metadata object.
</pre> <div class="fragment"><div class="line">DepthMetaData depthMD = <span class="keyword">new</span> DepthMetaData();</div>
</div><!-- fragment --><h2><a class="anchor" id="svcs_reader_thread_main_loop"></a>
Main Loop</h2>
<pre class="fragment">    The following statement updates all generator nodes in the context that have new data available, first waiting for a specified node to have new data available.         
</pre> <div class="fragment"><div class="line"><span class="keywordflow">try</span></div>
<div class="line">{</div>
<div class="line">    this.context.WaitOneUpdateAll(this.depth);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="svcs_glb_dcl_blk"></a>
Global Declaration Block</h1>
<pre class="fragment">    The global declaration block is at the bottom of the public MainWindow() block. The declarations are as follows.        
</pre> <div class="fragment"><div class="line"><span class="keyword">private</span> readonly <span class="keywordtype">string</span> SAMPLE_XML_FILE = <span class="stringliteral">@&quot;../../../../Data/SamplesConfig.xml&quot;</span>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span> Context context;</div>
<div class="line"><span class="keyword">private</span> ScriptNode scriptNode;</div>
<div class="line"><span class="keyword">private</span> DepthGenerator depth;</div>
<div class="line"><span class="keyword">private</span> Thread readerThread;</div>
<div class="line"><span class="keyword">private</span> <span class="keywordtype">bool</span> shouldRun;</div>
<div class="line"><span class="keyword">private</span> Bitmap bitmap;</div>
<div class="line"><span class="keyword">private</span> <span class="keywordtype">int</span>[] histogram;</div>
</div><!-- fragment --><p>Each of these declarations is described separately in the following paragraphs.</p>
<p>The following definition is for the path to an OpenNI XML script file for inputting and building a stored production graph. The <em>production graph</em> is a network of <em>production nodes</em> and is the principal OpenNI object model. The identifies blobs as hands or human users (focusing mainly on OpenNI specific declarations). </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define SAMPLE_XML_FILE &quot;../../../../Data/SamplesConfig.xml&quot;</span></div>
</div><!-- fragment --><p>A <a class="el" href="classxn_1_1_context.html">Context</a> object is a workspace in which the application builds an OpenNI production graph.</p>
<p>The <a class="el" href="classxn_1_1_script_node.html">ScriptNode</a> object loads an XML script from a file or string, and then runs the XML script to build a production graph. The ScriptNode object keeps references to all nodes created from the script, so they will not be destroyed. (This is since OpenNI will delete a node that has no remaining references to it.)</p>
<p>The <a class="el" href="classxn_1_1_depth_generator.html">DepthGenerator</a> node generates a depth map. Each map pixel value represents a distance from the sensor.</p>
<p>The following declarations are not OpenNI specific. <code>histogram</code> is a key part of this sample program. </p>
<div class="fragment"><div class="line"><span class="keyword">private</span> Thread readerThread;</div>
<div class="line"><span class="keyword">private</span> <span class="keywordtype">bool</span> shouldRun;</div>
<div class="line"><span class="keyword">private</span> Bitmap bitmap;</div>
<div class="line"><span class="keyword">private</span> <span class="keywordtype">int</span>[] histogram;</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Nov 12 2013 13:40:21 for OpenNI 1.5.7 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
